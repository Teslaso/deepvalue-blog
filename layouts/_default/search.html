{{ define "main" }}
<div class="book-search-page">
  <h1>{{ .Title }}</h1>

  <div class="book-search-container">
    <input id="book-search-input-page" type="text"
      placeholder="输入关键词搜索文章..."
      aria-label="搜索文章"
      maxlength="64"
      autocomplete="off"
      style="width: 100%; padding: 10px; font-size: 16px; margin-bottom: 20px;" />
    <div id="book-search-results-page" class="book-search-results"></div>
  </div>

  {{ .Content }}
</div>

<script>
// 增强搜索功能
(function() {
  const searchInput = document.getElementById('book-search-input-page');
  const searchResults = document.getElementById('book-search-results-page');

  if (!searchInput || !searchResults) return;

  let searchIndex = null;
  let searchData = null;

  // 加载搜索数据
  fetch('/index.search-data.json')
    .then(response => response.json())
    .then(data => {
      searchData = data;
      // 初始化 Fuse.js 索引
      searchIndex = new Fuse(data, {
        includeScore: true,
        threshold: 0.2,
        distance: 100,
        keys: [
          { name: 'title', weight: 0.7 },
          { name: 'content', weight: 0.3 },
          { name: 'categories', weight: 0.2 },
          { name: 'tags', weight: 0.2 }
        ]
      });
    })
    .catch(error => console.error('搜索数据加载失败:', error));

  // 搜索功能
  function performSearch() {
    const query = searchInput.value.trim();

    if (!query) {
      searchResults.innerHTML = '';
      return;
    }

    if (!searchIndex) {
      searchResults.innerHTML = '<p>搜索功能加载中...</p>';
      return;
    }

    const results = searchIndex.search(query);

    if (results.length === 0) {
      searchResults.innerHTML = '<p>没有找到相关文章</p>';
      return;
    }

    // 显示搜索结果
    let html = '<ul class="search-results-list">';
    results.slice(0, 10).forEach(result => {
      const item = result.item;
      const score = Math.round((1 - result.score) * 100);

      html += `
        <li class="search-result-item">
          <a href="${item.href}" class="search-result-link">
            <div class="search-result-title">${item.title}</div>
            <div class="search-result-summary">${item.summary || item.content.substring(0, 150)}...</div>
            <div class="search-result-meta">
              ${item.categories ? item.categories.map(cat => `<span class="search-result-category">${cat}</span>`).join('') : ''}
              ${item.tags ? item.tags.map(tag => `<span class="search-result-tag">${tag}</span>`).join('') : ''}
              <span class="search-result-score">匹配度: ${score}%</span>
            </div>
          </a>
        </li>
      `;
    });
    html += '</ul>';

    searchResults.innerHTML = html;
  }

  // 监听输入事件
  let searchTimeout;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(performSearch, 300); // 300ms 防抖
  });

  // 自动聚焦
  searchInput.focus();
})();
</script>

<style>
.book-search-page {
  max-width: 800px;
  margin: 0 auto;
}

.book-search-container {
  margin: 20px 0;
}

.search-results-list {
  list-style: none;
  padding: 0;
}

.search-result-item {
  margin-bottom: 20px;
  padding: 15px;
  border: 1px solid #e1e4e8;
  border-radius: 6px;
  transition: all 0.2s;
}

.search-result-item:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.search-result-link {
  text-decoration: none;
  color: inherit;
  display: block;
}

.search-result-title {
  font-size: 18px;
  font-weight: 600;
  color: #0366d6;
  margin-bottom: 8px;
}

.search-result-summary {
  color: #586069;
  font-size: 14px;
  line-height: 1.5;
  margin-bottom: 10px;
}

.search-result-meta {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.search-result-category,
.search-result-tag {
  display: inline-block;
  padding: 2px 8px;
  font-size: 12px;
  border-radius: 3px;
  background-color: #f1f8ff;
  color: #0366d6;
}

.search-result-tag {
  background-color: #f6f8fa;
  color: #586069;
}

.search-result-score {
  font-size: 12px;
  color: #28a745;
  margin-left: auto;
}

#book-search-input-page {
  border: 2px solid #e1e4e8;
  border-radius: 6px;
  transition: border-color 0.2s;
}

#book-search-input-page:focus {
  outline: none;
  border-color: #0366d6;
}
</style>
{{ end }}